name: idapt

services:

  idapt:
    container_name: idapt
    build:
      context: .
      dockerfile: ./Dockerfile
    environment:
      # Frontend variables
      ENVIRONMENT: prod
      NEXT_PUBLIC_HOST_DOMAIN: localhost
      # Entrypoint script variables
      HOST_DOMAIN: localhost
      # Container variables
      CERTBOT_EMAIL: dummy@dummy.com
      USE_LOCAL_CA: 1
    env_file:
      - ./nginx/.env
      - ./frontend/.env
      - ./backend/.env
    ports:
      # Expose the nginx listening ports through the host firewall.
      # Add 127.0.0.1 to only open ports locally and not through the host firewall.
      - '127.0.0.1:80:80/tcp'
      - '127.0.0.1:443:443/tcp'
      - '127.0.0.1:443:443/udp'
    # Expose the host.docker.internal so that we can access ollama runnning on the localost from the container.
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # Nginx has access to every container exposed via their own network for routing.
    networks:
      idapt-external-network: {}
    volumes:
      - nginx_data:/etc/letsencrypt # Persist the certificates.
      - backend_data:/backend_data # The volume where the app data is stored.
      - idapt_data:/data # The volume where the data is stored. Use data mount name to make it shorter.
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1/api/health && nginx -t || exit 1"]
      interval: 5s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: always
    # Container security hardening
    security_opt:
      - no-new-privileges:true
    #cap_drop: # TODO
    #  - ALL
    #cap_add:
    #  - NET_BIND_SERVICE  # Only for nginx

volumes:
  backend_data:
  idapt_data:
  nginx_data:

# One network for each service to keep them isolated.
networks:
  # Dedicated external networks for services that need internet access
  idapt-external-network:
    attachable: false
    name: idapt-external-network
    driver: bridge